<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin â€¢ UNSEEN</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@200;300;400;600&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ static_url('unseen.css') }}">
</head>
<body>
  <header>
    <div class="wrap">
      <div class="nav">
        <div class="brand">
          <img class="brandLogo" src="{{ static_url('unseen_logo_simple_plain.svg') }}" alt="UNSEEN logo">
        </div>
        <div class="cta">
          <form method="post" action="{{ base_path }}/logout">
            <button class="btn" type="submit">Logout</button>
          </form>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="pageSection">
      <div class="wrap dashGrid adminGrid">
        <div class="card balanceCard" style="grid-column: 1 / -1;">
          <h3>Balance</h3>
          <p class="fineprint">Leaders / Followers by stage</p>
          <div class="balanceGrid">
            <div class="balanceItem">
              <div class="fineprint">Pending email verification</div>
              <div class="balanceCounts">
                <span class="countBadge">L <b>{{ reg_stats.get("pending_email", {}).get("leader", 0) }}</b></span>
                <span class="countBadge">F <b>{{ reg_stats.get("pending_email", {}).get("follower", 0) }}</b></span>
              </div>
            </div>
            <div class="balanceItem">
              <div class="fineprint">Registered</div>
              <div class="balanceCounts">
                <span class="countBadge">L <b>{{ reg_stats.get("registered", {}).get("leader", 0) }}</b></span>
                <span class="countBadge">F <b>{{ reg_stats.get("registered", {}).get("follower", 0) }}</b></span>
              </div>
            </div>
            <div class="balanceItem">
              <div class="fineprint">Paid</div>
              <div class="balanceCounts">
                <span class="countBadge">L <b>{{ reg_stats.get("paid", {}).get("leader", 0) }}</b></span>
                <span class="countBadge">F <b>{{ reg_stats.get("paid", {}).get("follower", 0) }}</b></span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Create invitation</h3>
          <form method="post" action="{{ base_path }}/admin/invites">
            <div class="formRow">
              <div>
                <label for="label">Name</label>
                <input type="text" id="label" name="label" placeholder="Ivan Ivanov">
              </div>
              <div>
                <label for="code">Invitation code</label>
                <input type="text" id="code" name="code" placeholder="generate if blank">
              </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:6px;">
              <button class="btn primary" type="submit">Create invite</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h3>Invitations</h3>
          <div class="tableSimple invitesTable">
            <div class="tableHead">
              <div>Label</div><div>Code</div><div>Link</div><div>Created</div>
            </div>
            {% for inv in invites %}
            <div class="tableRow">
              <div>{{ inv.get("label") }}</div>
              <div><code>{{ inv.get("code") }}</code></div>
              <div class="inviteLinkCell">
                <a
                  class="fineprint inviteLink"
                  href="{{ base_url }}/register/{{ inv.get('code') }}"
                  data-copy-link="{{ base_url }}/register/{{ inv.get('code') }}"
                  title="Click to copy invite link"
                >
                  {{ base_url }}/register/{{ inv.get("code") }}
                </a>
              </div>
              <div class="fineprint inviteCreated">{{ fmt_ts(inv.get("created_at")) }}</div>
            </div>
            {% end %}
            {% if not invites %}
            <div class="fineprint">No invites yet.</div>
            {% end %}
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
          <h3>Registrations</h3>
          <div class="tableSimple registrationsTable">
            <div class="tableHead">
              <div>Name</div><div>Email</div><div>Role / Level</div><div>Phone</div><div>Group</div><div>Status</div><div>Actions</div>
            </div>
            {% for reg in registrations %}
            {% set post_meta = reg.get("post_meta", {}) %}
            {% set verified = reg.get("email_verified_at") %}
            {% set paid = reg.get("payment_approved") %}
            <div class="tableRow">
              <div>{{ reg.get("first_name") }} {{ reg.get("last_name") }}</div>
              <div class="fineprint">{{ reg.get("email") }}</div>
              <div>{{ reg.get("role","").title() }} / {{ reg.get("level","").title() }}</div>
              <div>{{ reg.get("phone") }}</div>
              <div>
                {% if post_meta.get("whatsapp_opt_in") %}
                  <span class="statusBadge success">Requested</span>
                {% else %}
                  <span class="fineprint">No request</span>
                {% end %}
              </div>
              <div>
                {% if not verified %}
                  <span class="statusBadge muted">Email pending</span>
                {% elif not paid %}
                  <span class="statusBadge warn">Awaiting payment</span>
                {% else %}
                  <span class="statusBadge success">Paid</span>
                {% end %}
              </div>
              <div class="rowActions">
                <form method="post" action="{{ base_path }}/admin/approve/{{ reg.get('_id') }}" style="display:flex; gap:8px;">
                  {% if reg.get("payment_approved") %}
                  <button class="btn" name="action" value="revoke" type="submit">Revoke</button>
                  {% else %}
                  <button class="btn primary" name="action" value="approve" type="submit">Approve</button>
                  {% end %}
                </form>
                <button class="btn ghost detailsToggle" type="button" aria-expanded="false" data-details-target="{{ reg.get('_id') }}">
                  <span class="chevron"></span>
                </button>
              </div>
            </div>
            <div class="regDetails" data-details="{{ reg.get('_id') }}" hidden>
              <div class="regDetailGrid">
                <div>
                  <div class="fineprint">Invite code</div>
                  <div>{{ reg.get("invite_code") or "-" }}</div>
                </div>
                <div>
                  <div class="fineprint">Registered</div>
                  <div>{{ fmt_ts(reg.get("created_at")) }}</div>
                </div>
                <div>
                  <div class="fineprint">Partner</div>
                  <div>
                    {% if reg.get("partner_name") %}
                      {{ reg.get("partner_name") }}{% if reg.get("partner_contact") %} ({{ reg.get("partner_contact") }}){% end %}
                    {% else %}
                      -
                    {% end %}
                  </div>
                </div>
                <div>
                  <div class="fineprint">Special conditions</div>
                  <div>{{ reg.get("special_conditions") or "-" }}</div>
                </div>
                <div>
                  <div class="fineprint">Allergies / notes</div>
                  <div>{{ post_meta.get("allergies") or "-" }}</div>
                </div>
                <div>
                  <div class="fineprint">WhatsApp group</div>
                  <div>{% if post_meta.get("whatsapp_opt_in") %}Requested{% else %}-{% end %}</div>
                </div>
                {% for rec in post_meta.get("opposite") or [] %}
                <div>
                  <div class="fineprint">Opposite rec</div>
                  <div>{{ rec.get("name") }} ({{ rec.get("contact") }})</div>
                  <div class="fineprint">Status: {% if rec.get("registered") %}Registered{% elif rec.get("processed") %}Processed{% else %}Open{% end %}</div>
                </div>
                {% end %}
                {% if post_meta.get("same") %}
                <div>
                  <div class="fineprint">Same role rec</div>
                  <div>{{ post_meta.get("same").get("name") }} ({{ post_meta.get("same").get("contact") }})</div>
                  <div class="fineprint">Status: {% if post_meta.get("same").get("registered") %}Registered{% elif post_meta.get("same").get("processed") %}Processed{% else %}Open{% end %}</div>
                </div>
                {% end %}
              </div>
            </div>
            {% end %}
            {% if not registrations %}
            <div class="fineprint">No registrations yet.</div>
            {% end %}
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
          <h3>Invite suggestions</h3>
          <p class="fineprint">From participant recommendations</p>
          {% if invite_suggestions %}
          <div class="tableToolbar">
            <div class="filtersRow">
              <label class="checkboxInline">
                <input type="checkbox" id="filter-unprocessed">
                <span>Show unprocessed only</span>
              </label>
              <label class="checkboxInline">
                <input type="checkbox" id="filter-unregistered">
                <span>Show unregistered only</span>
              </label>
            </div>
            <div class="sortRow">
              <label class="fineprint" for="sort-suggestions" style="margin-right:6px;">Sort by</label>
              <select id="sort-suggestions">
                <option value="name">Suggested name</option>
                <option value="potential_role">Potential role</option>
                <option value="source">Source</option>
                <option value="status">Status</option>
              </select>
            </div>
          </div>
          {% end %}
          <div class="tableSimple suggestionsTable">
            <div class="tableHead">
              <div>Suggested</div><div>Contact</div><div>Potential role</div><div>Source</div><div>Status</div>
            </div>
            {% for sug in invite_suggestions %}
            <div
              class="tableRow"
              data-suggestion="true"
              data-name="{{ sug.get('name','').lower() }}"
              data-potential-role="{{ sug.get('potential_role','').lower() }}"
              data-source="{{ sug.get('source_name','').lower() }}"
              data-processed="{{ 'true' if sug.get('processed') else 'false' }}"
              data-registered="{{ 'true' if sug.get('registered') else 'false' }}"
            >
              <div>{{ sug.get("name") }}</div>
              <div class="fineprint">{{ sug.get("contact") }}</div>
              <div>{{ sug.get("potential_role","").title() }}</div>
              <div>
                <div>{{ sug.get("source_name") }}</div>
                <div class="fineprint">{{ sug.get("source_email") }}</div>
                <div class="fineprint">Role: {{ sug.get("source_role","").title() or "-" }}</div>
              </div>
              <div>
                <form method="post" action="{{ base_path }}/admin/suggestions/{{ sug.get('source_id') }}" class="suggestionForm" data-autosubmit="true">
                  <input type="hidden" name="kind" value="{{ sug.get('kind') }}">
                  <input type="hidden" name="index" value="{{ sug.get('index') }}">
                  <label class="checkboxInline">
                    <input type="checkbox" name="processed" value="true" {% if sug.get("processed") %}checked{% end %}>
                    <span>Processed</span>
                  </label>
                  <label class="checkboxInline">
                    <input type="checkbox" name="registered" value="true" {% if sug.get("registered") %}checked{% end %}>
                    <span>Registered</span>
                  </label>
                </form>
              </div>
            </div>
            {% end %}
            {% if invite_suggestions %}
            <div class="fineprint" id="suggestions-empty" hidden>No matching suggestions.</div>
            {% end %}
            {% if not invite_suggestions %}
            <div class="fineprint">No suggestions yet.</div>
            {% end %}
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (() => {
      const copyText = async (text) => {
        if (navigator.clipboard && window.isSecureContext) {
          return navigator.clipboard.writeText(text);
        }
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try{
          const ok = document.execCommand('copy');
          ta.remove();
          return ok ? Promise.resolve() : Promise.reject(new Error('copy failed'));
        }catch(err){
          ta.remove();
          return Promise.reject(err);
        }
      };

      const updateLabel = (btn, msg) => {
        const original = btn.dataset.originalLabel || btn.textContent.trim();
        if (!btn.dataset.originalLabel) btn.dataset.originalLabel = original;
        btn.textContent = msg;
        setTimeout(() => { btn.textContent = btn.dataset.originalLabel; }, 1200);
      };

      document.addEventListener('click', (evt) => {
        const btn = evt.target.closest('[data-copy-link]');
        if (!btn) return;
        evt.preventDefault();
        const link = btn.getAttribute('data-copy-link');
        if (!link) return;
        copyText(link)
          .then(() => updateLabel(btn, 'Copied!'))
          .catch(() => updateLabel(btn, 'Copy failed'));
      });

      document.addEventListener('click', (evt) => {
        const toggle = evt.target.closest('[data-details-target]');
        if (!toggle) return;
        const id = toggle.getAttribute('data-details-target');
        if (!id) return;
        const panel = document.querySelector(`[data-details="${id}"]`);
        if (!panel) return;
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          panel.setAttribute('hidden', '');
          toggle.setAttribute('aria-expanded', 'false');
        } else {
          panel.removeAttribute('hidden');
          toggle.setAttribute('aria-expanded', 'true');
        }
      });

      document.addEventListener('change', (evt) => {
        const form = evt.target.closest('form[data-autosubmit="true"]');
        if (!form) return;
        form.submit();
      });

      const filterUnprocessed = document.getElementById('filter-unprocessed');
      const filterUnregistered = document.getElementById('filter-unregistered');
      const sortSelect = document.getElementById('sort-suggestions');
      const suggestionsTable = document.querySelector('.suggestionsTable');
      const emptyState = document.getElementById('suggestions-empty');

      const getRows = () => Array.from(suggestionsTable?.querySelectorAll('[data-suggestion="true"]') || []);

      const statusRank = (row) => {
        const registered = row.dataset.registered === 'true';
        const processed = row.dataset.processed === 'true';
        if (!processed && !registered) return 0;
        if (processed && !registered) return 1;
        return 2;
      };

      const applyFiltersAndSort = () => {
        const rows = getRows();
        const wantUnprocessed = !!filterUnprocessed?.checked;
        const wantUnregistered = !!filterUnregistered?.checked;
        const sortBy = sortSelect?.value || 'name';

        const sorted = rows.slice().sort((a, b) => {
          const aName = a.dataset.name || '';
          const bName = b.dataset.name || '';
          const aRole = a.dataset.potentialRole || '';
          const bRole = b.dataset.potentialRole || '';
          const aSource = a.dataset.source || '';
          const bSource = b.dataset.source || '';
          if (sortBy === 'potential_role') return aRole.localeCompare(bRole) || aName.localeCompare(bName);
          if (sortBy === 'source') return aSource.localeCompare(bSource) || aName.localeCompare(bName);
          if (sortBy === 'status') return statusRank(a) - statusRank(b) || aName.localeCompare(bName);
          return aName.localeCompare(bName);
        });

        let visibleCount = 0;
        sorted.forEach((row) => {
          const processed = row.dataset.processed === 'true';
          const registered = row.dataset.registered === 'true';
          let show = true;
          if (wantUnprocessed && processed) show = false;
          if (wantUnregistered && registered) show = false;
          if (show) visibleCount += 1;
          row.classList.toggle('is-hidden', !show);
        });

        if (suggestionsTable) {
          const head = suggestionsTable.querySelector('.tableHead');
          const fragment = document.createDocumentFragment();
          if (head) fragment.appendChild(head);
          sorted.forEach((row) => fragment.appendChild(row));
          if (emptyState) fragment.appendChild(emptyState);
          suggestionsTable.innerHTML = '';
          suggestionsTable.appendChild(fragment);
        }

        if (emptyState) {
          emptyState.classList.toggle('is-hidden', visibleCount !== 0);
        }
      };

      [filterUnprocessed, filterUnregistered, sortSelect].forEach((el) => {
        if (!el) return;
        el.addEventListener('change', applyFiltersAndSort);
      });

      if (suggestionsTable) {
        applyFiltersAndSort();
      }
    })();
  </script>
</body>
</html>
